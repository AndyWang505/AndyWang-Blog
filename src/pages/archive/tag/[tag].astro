---
import { getCollection } from 'astro:content';
import FormattedDate from '../../../components/FormattedDate.astro';
import Layout from '../../../layouts/Layout.astro';
import Aside from '../../../layouts/Aside.astro';
import MobileNav from '../../../components/MobileNav.astro';
import CardItem from '../../../components/CardItem.astro';

const blog = await getCollection('blog');

export async function getStaticPaths() {
  const blog = await getCollection('blog');
  const tagsSet = new Set<string>();
  blog.forEach((post) => {
    post.data.tags.forEach((tag) => tagsSet.add(tag));
  });
  const tagsArray = Array.from(tagsSet);
  return tagsArray.map((tag) => ({
    params: { tag },
  }));
}

const { tag } = Astro.params;

const avaliableCurrentTagPosts = blog
  .filter((post) => post.data.tags.includes(tag as string))
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
---

<Layout>
  <!-- Main content wrapper with same layout as index.astro -->
  <div class="relative max-w-[var(--page-width)] mx-auto">
    <div class="transition duration-700 w-full grid grid-cols-[17.5rem_auto] grid-rows-[auto_1fr_auto] lg:grid-rows-[auto] mx-auto gap-4">
      <Aside />
      <!-- mobile nav -->
      <MobileNav />
      <main class="col-span-2 lg:col-span-1 p-0 overflow-hidden">
        <div class="onload-animation">
          <section class="space-y-4">
      <!-- Header -->
      <div class="bg-white dark:bg-zinc-900 rounded-xl shadow-sm dark:shadow-gray-900/20 p-6">
        <nav class="flex items-center gap-2 text-sm text-neutral-500 dark:text-neutral-400 mb-4">
          <a href="/archive/" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors">
            Archive
          </a>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M8.59 16.58L13.17 12L8.59 7.41L10 6L16 12L10 18L8.59 16.58Z"/>
          </svg>
          <a href="/archive/tag/" class="hover:text-blue-600 dark:hover:text-blue-400 transition-colors">
            Tags
          </a>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M8.59 16.58L13.17 12L8.59 7.41L10 6L16 12L10 18L8.59 16.58Z"/>
          </svg>
          <span class="text-zinc-900 dark:text-zinc-100 font-medium">{tag}</span>
        </nav>
        
        <div class="flex items-center gap-3 mb-2">
          <div class="p-2 bg-green-100 dark:bg-green-900/20 rounded-lg">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-green-600 dark:text-green-400">
              <path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83 0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <line x1="7" y1="7" x2="7.01" y2="7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
          <div>
            <h1 class="text-2xl md:text-3xl font-bold text-zinc-900 dark:text-zinc-100">{tag}</h1>
            <p class="text-neutral-500 dark:text-neutral-400">{avaliableCurrentTagPosts.length} posts with this tag</p>
          </div>
        </div>
      </div>

      <!-- Posts List -->
      <div>
        {avaliableCurrentTagPosts.map((post) => (
          <CardItem 
            slug={post.slug}
            title={post.data.title}
            heroImage={post.data.heroImage || ''}
            pubDate={post.data.pubDate}
            category={post.data.category}
            tags={post.data.tags}
            description={post.data.description}
            content={post.body}
          />
        ))}
      </div>
          </section>
        </div>
      </main>
    </div>
  </div>
</Layout>
