---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import Banner from '../components/Banner.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../config/site';
import { 
  BANNER_CONFIG, 
  BANNER_HEIGHT, 
  BANNER_HEIGHT_EXTEND, 
  BANNER_HEIGHT_HOME, 
  MAIN_PANEL_OVERLAPS_BANNER_HEIGHT,
  PAGE_WIDTH 
} from '../config/banner';
import '../styles/transition.css';
import '../styles/photoswipe.css';

export interface Props {
  title?: string;
  image?: string;
  description?: string;
  banner?: string;
}

const { title, image, description, banner } = Astro.props;
const dynamicTitle = title || SITE_TITLE;
const dynamicDescription = description || SITE_DESCRIPTION;

const isHomePage = Astro.url.pathname === '/' || Astro.url.pathname === '';

const mainPanelTop = BANNER_CONFIG.enable 
  ? `calc(${BANNER_HEIGHT}vh - ${MAIN_PANEL_OVERLAPS_BANNER_HEIGHT}rem)` 
  : "5.5rem";
const bannerOffset = (() => {
  const positions = {
    top: `${BANNER_HEIGHT_EXTEND}vh`,
    center: `${BANNER_HEIGHT_EXTEND / 2}vh`,
    bottom: "0",
  };
  return positions[BANNER_CONFIG.position as keyof typeof positions] || positions.center;
})();
---

<html lang="zh_TW">
  <head>
    <BaseHead title={dynamicTitle} description={dynamicDescription} image={image} />
    <script is:inline>
      (function () {
        const theme = (() => {
          if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
            return localStorage.getItem('theme');
          }
          if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            return 'dark';
          }
          return 'light';
        })();

        if (theme === 'dark') {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      })();
    </script>
    
    <script is:inline define:vars={{
      BANNER_HEIGHT_EXTEND, 
      PAGE_WIDTH, 
      BANNER_HEIGHT, 
      BANNER_HEIGHT_HOME
    }}>
      let offset = Math.floor(window.innerHeight * (BANNER_HEIGHT_EXTEND / 100));
      offset = offset - offset % 4;
      document.documentElement.style.setProperty('--banner-height-extend', `${offset}px`);
      
      document.documentElement.style.setProperty('--banner-height', `${BANNER_HEIGHT}vh`);
      document.documentElement.style.setProperty('--banner-height-home', `${BANNER_HEIGHT_HOME}vh`);
      const currentPath = window.location.pathname;
      const isHome = currentPath === '/' || currentPath === '';
      if (isHome && !document.body.classList.contains('is-home')) {
        document.body.classList.add('is-home');
      } else if (!isHome && document.body.classList.contains('is-home')) {
        document.body.classList.remove('is-home');
      }
    </script>
    
    <style define:vars={{
      'page-width': `${PAGE_WIDTH}rem`,
      'main-panel-top': mainPanelTop,
      bannerOffset,
    }}>
      :root {
        --page-width: var(--page-width);
        --main-panel-top: var(--main-panel-top);
        --banner-offset: var(--bannerOffset);
      }
    </style>
  </head>

  <body class="min-h-screen transition-colors duration-300 relative" class:list={[
    {"is-home": isHomePage, "enable-banner": BANNER_CONFIG.enable}
  ]}>
    <!-- Header -->
    <div id="top-row" class="z-50 pointer-events-none relative transition-all duration-700 max-w-[var(--page-width)] px-0 mx-auto">
      <div id="navbar-wrapper" class="pointer-events-auto sticky top-0 transition-all">
        <Header />
      </div>
    </div>

    <!-- Banner -->
    <Banner />

    <!-- Main Content -->
    <div class="absolute w-full z-30 pointer-events-none" style={`top: var(--main-panel-top)`}>
      <div class="relative max-w-[var(--page-width)] mx-auto pointer-events-auto">
        <div id="main-grid" class="transition-all duration-700 w-full px-0 flex flex-col min-h-[calc(100vh-var(--main-panel-top))]">
          <main id="swup-container" class="transition-swup-fade overflow-hidden flex-1">
            <div id="content-wrapper">
              <slot />
            </div>
          </main>
          
        </div>
      </div>
      <!-- Full-width Footer -->
      <div class="footer-wrapper pt-16 pointer-events-auto w-full">
        <Footer />
      </div>
    </div>
    
    <!-- Page height extend for smooth transitions -->
    <div id="page-height-extend" class="hidden h-[300vh]"></div>
  </body>
</html>

<!-- dynamic banner height style -->
<style is:global define:vars={{bannerOffset}}>
@tailwind components;

@layer components {
  body {
    @apply min-h-screen;
  }

  .enable-banner #banner-wrapper {
    height: var(--banner-height);
    top: 0;
    transition: height 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94), 
                top 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }

  .enable-banner #banner {
    height: var(--banner-height);
    transition: height 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94), 
                transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }
  
  body.is-home.enable-banner #banner-wrapper {
    height: var(--banner-height-home);
    top: calc(-1 * var(--banner-height-extend));
  }

  body.is-home.enable-banner #banner {
    height: var(--banner-height-home);
  }

  #main-grid {
    transform: translateY(0);
    transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }

  body.is-home.enable-banner #main-grid {
    transform: translateY(var(--banner-height-extend));
  }

  .enable-banner #top-row {
    height: calc(var(--banner-height) - 4.5rem);
    transition: all 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  }

  /* Mobile banner height override - keep base height on mobile */
  @media (max-width: 768px) {
    .enable-banner #banner-wrapper {
      height: var(--banner-height) !important;
      top: 0 !important;
    }

    .enable-banner #banner {
      height: var(--banner-height) !important;
    }
    
    body.is-home.enable-banner #banner-wrapper {
      height: var(--banner-height) !important;
      top: 0 !important;
    }

    body.is-home.enable-banner #banner {
      height: var(--banner-height) !important;
    }

    body.is-home.enable-banner #main-grid {
      transform: translateY(0) !important;
    }
  }

  .enable-banner #banner.show {
    opacity: 1;
    transform: scale(1);
  }
  
  .enable-banner #banner {
    opacity: 0;
    animation: bannerFadeIn 0.8s ease-out forwards;
  }

  .enable-banner #banner.loaded {
    animation: none;
    opacity: 1;
  }
  
  .navbar-hidden {
    opacity: 0;
    transform: translateY(-4rem);
    transition: opacity 0.3s ease-out, transform 0.3s ease-out;
  }
  
  @keyframes bannerFadeIn {
    0% {
      opacity: 0;
      transform: scale(1.05);
    }
    100% {
      opacity: 1;
      transform: scale(1);
    }
  }

  .footer-wrapper {
    @apply relative z-10 w-full;
  }
  
  #content-wrapper {
    @apply pb-8;
  }
  
  #swup-container {
    @apply min-h-[50vh];
  }
}
</style>

<script>
  import '../scripts/main';
</script>
